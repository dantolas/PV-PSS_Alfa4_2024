package com.kuta.tcp;

import java.io.IOException;
import java.io.PrintStream;
import java.io.PrintWriter;
import java.net.InetAddress;
import java.net.Socket;
import java.util.Scanner;

import com.kuta.util.color.ColorMe;
import com.kuta.vendor.GsonParser;

/**
 * TCPClient
 */
public class TCPClient implements Runnable{
    public boolean running;

    private Socket client;
    private String endpointPeerId;
    private int timeout;
    private PrintStream sysout;
    private PrintWriter out;
    private Scanner in;

    private final String HELLO;

    private final String TCPc;

    private InetAddress ip;
    private int port;
    private volatile boolean sendNow;
    private String msg;

    /**
     * Main constructor for instantiating a TCPClient. 
     *
     * @param ip IPv4 to connect to
     * @param port Port number to connect to
     * @param endpointPeerId Peer id of the endpoint connection
     * @param myPeerId Peer id of the server
     * @param sysout System.out for printing info
     */
    public TCPClient(InetAddress ip, int port,String endpointPeerId,String myPeerId, PrintStream sysout, boolean sendNow, String msg) {
        this.sysout = (sysout);
        this.ip = ip;
        this.port = port;
        this.endpointPeerId = endpointPeerId;
        this.TCPc = ColorMe.yellow("TCPc-"+endpointPeerId);
        this.HELLO = GsonParser.parser.toJson(new HelloTCP("hello",myPeerId));
        this.sendNow = sendNow;
        this.msg = msg;
    }

    public void setup() {
        sysout.println(TCPc+"|Attempting connection to "+ColorMe.green(endpointPeerId)+ip+":"+port);
        try {
            client = new Socket(ip, port);
            out = new PrintWriter(client.getOutputStream(), true);
            in = new Scanner(client.getInputStream());
            sysout.println(TCPc+"|Connection established");
            sysout.flush();
            running = true;
        } catch (Exception e) {
            e.printStackTrace();
        }
    }


    public void tearDown() {
        sysout.println(TCPc+"|Closing tcp connection");
        in.close();
        out.close();
        try {
            client.close();
        } catch (IOException e) {
            e.printStackTrace();
        }
        sysout.println(TCPc+"|Connection closed");
    }
    public String newMessage(String msg){
        return GsonParser.parser.toJson(new NewTCPMessage("new_message", Long.toString(System.currentTimeMillis())
            ,msg));
    }

    private void checkTimeout(long timePassed) throws TimeoutException{
        if(timePassed > timeout) throw new TimeoutException("Connection timed out");
    };
    private String readResponse() throws TimeoutException{
        String resp = null;
        long timeStartedWaiting = System.currentTimeMillis();
        while(resp == null){
            long waitingTime = System.currentTimeMillis() - timeStartedWaiting;
            checkTimeout(waitingTime);
            resp = in.nextLine();
        }
        return resp;
    }
    public String send(String txt) throws TimeoutException {
        if(out == null) return "";
        out.println(txt);
        String resp = readResponse();
        return resp;
    }
    @Override
    public void run() {
        setup();
        try {
            sysout.println(TCPc+"|"+send(HELLO));
            while(running){
                synchronized(msg){
                    msg.wait();
                    sysout.println(TCPc+"|Sending msg");
                    String response = send(newMessage(this.msg));
                    sysout.println(TCPc+"|"+response);
                }
                if(!this.sendNow) continue;
                sysout.println(TCPc+"| sendNow = "+sendNow);
                Thread.sleep(4000);
                this.sendNow = false;
            }
        } catch (TimeoutException e) {
            sysout.println(TCPc+"|Connection timed out");
        } catch (Exception e){
            e.printStackTrace();
        }
        finally{
            tearDown();
        }
        
    }
    
}
